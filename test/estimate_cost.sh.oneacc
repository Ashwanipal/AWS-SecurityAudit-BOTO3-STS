#!/bin/sh

######### Cradentials ################################
MUSQL_USER="root"
#MYSQL_PASS="ankur"
MYSQL_PASS="pass123"
MYSQL_DB="HI_BILLING"

########## Refreshing Database #######################
mysql -u $MUSQL_USER -p$MYSQL_PASS $MYSQL_DB -e 'truncate hiaws_ca;'
mysql -u $MUSQL_USER -p$MYSQL_PASS $MYSQL_DB --local-infile < /home/hashedin/AWS_SECURITY_AUDIT/load-data
echo $1
ID=$1
######### cost estimation ##########
echo "<div style='width:90%;'><h3>Cost Estimation for Account $2</h3>" >>/tmp/email_output.html
echo "<table style='width:98%', border='1'><thead><th>DATE</th><th>COST in US$</th></thead><tbody>" >>/tmp/email_output.html

dates=$(mysql -u $MUSQL_USER -p$MYSQL_PASS $MYSQL_DB -e "select date_format(ca_UsageEndDate,'%Y-%m-%d') from hiaws_ca group by date_format(ca_UsageEndDate,'%Y-%m-%d')" | tail -4)
	for date in $dates
        do
		Cost=$(mysql -u $MUSQL_USER -p$MYSQL_PASS $MYSQL_DB -e "select SUM(ca_Cost) from hiaws_ca where ca_LinkedAccountId = "$ID" AND date_format(ca_UsageEndDate,'%Y-%m-%d') = '"$date"';" | sed -n '1!p')
		echo "DATE = $date  | COST = $Cost"
                echo "<tr><td>$date</td><td>$Cost</td></tr>" >>/tmp/email_output.html
        done
total=$(mysql -u $MUSQL_USER -p$MYSQL_PASS $MYSQL_DB -e "select SUM(ca_Cost) as Cost from hiaws_ca where ca_LinkedAccountId = "$ID";" | sed -n '1!p')
echo "<tr><td><b>Total cost up to today</b></td><td>$total</td></tr>" >>/tmp/email_output.html
echo "</tbody></table></div>" >>/tmp/email_output.html

#total_cost=$(mysql -u $MUSQL_USER -p$MYSQL_PASS $MYSQL_DB -e 'select SUM(ca_Cost) as Cost from hiaws_ca;' | sed -n '1!p')
